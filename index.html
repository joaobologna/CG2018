<html>
	<head>
		<title>Projeto CG - Fase 03</title>
		<style>
			body { margin: 0; overflow: 0; }
			canvas { width: 100%; height: 100%; };
		</style>
	</head>
	<body>
		<canvas id="myCanvas"></canvas>
		<script src="js/three.js"></script>
		<script src="js/THREEx.KeyboardState.js"></script>
		
		<script id="vertexShader" type="x-shader/x-vertex">
		  varying vec3 vNormal;
		  varying vec3 vViewPosition;
		  uniform float timeDelta;
		  void main() {
			vec3 center = vec3(0.0, 0.0, 0.0);
			vec3 p = position;
			float distance = length(center - p);
			p += sin(distance + timeDelta/1000.0)*0.5;
			vec4 modelViewPosition = modelViewMatrix * vec4(p, 1.0);
			vViewPosition = -modelViewPosition.xyz;
			gl_Position = projectionMatrix * modelViewPosition;
			vNormal = normalMatrix * normal;
		  }
		</script>
		
		<script>
			var keyboard = new THREEx.KeyboardState();
			var sideCameraEnabled = true;
			var cat, rat, knife, cheese;			

			init();		

			function init() {
				// Renderer
				renderer = create_renderer();
				
				// Camera com visão superior
				upCamera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
				upCamera.position.set(5, 25, -10);
				upCamera.rotation.x = -90 * Math.PI / 180;

				// Camera com visão lateral
				sideCamera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
				sideCamera.position.set(5, 0.6, 10);
			
				// Cena
				scene = new THREE.Scene();
				
				var uniforms = ({
					timeDelta : {type: 'f', value: 0},
					emissive : {type: 'c', value: new THREE.Color(0x5e807f)},
					specular : {type: 'c', value: new THREE.Color(0xe09278)}
				});
				var phongShader = THREE.ShaderLib.phong;
				
				var mUniforms = THREE.UniformsUtils.merge([phongShader.uniforms, uniforms]);
				
				// define catMaterial
				var catMaterial = new THREE.ShaderMaterial ({
					uniforms : mUniforms,
					vertexShader: document.getElementById( 'vertexShader' ).textContent,
					fragmentShader: phongShader.fragmentShader,
					lights: true,
					side : THREE.DoubleSide
				});

				load_obj('json/cat.json', [10, 4, 4], [-4, 0, 0], [0, 1.6, 0]);
				load_obj('json/rat.js', [0.8, 1, 1], [4, 0, 0], [0, 1.6, 0]);
				load_obj('json/knife.js', [0.007, 0.007, 0.007], [10, 2, 2], [10, 0, 0]);
				load_obj('json/cheese.js', [0.2, 0.2, 0.2], [10, 0, -2], [0, 0 ,0]);

				function create_renderer() {
					var myCanvas = document.getElementById('myCanvas');
			
					renderer = new THREE.WebGLRenderer({
					  canvas: myCanvas, 
					  antialias: true
					});
			
					// Renderer
					renderer.setClearColor(0x000000);
					renderer.setPixelRatio(window.devicePixelRatio);
					renderer.setSize(window.innerWidth, window.innerHeight);
					
					return renderer;				
				}

				function load_obj(path, dimensions, position, rotation) {
					loader = new THREE.JSONLoader();
					loader.load(path, handle_load);
			
					function handle_load(geometry, materials) {
						materials = new THREE.MeshNormalMaterial();
						mesh = new THREE.Mesh(geometry, materials);
						mesh.scale.set(dimensions[0], dimensions[1], dimensions[2]); // alteração do tamanho do objeto
						mesh.position.x = position[0];
						mesh.position.y = position[1];
						mesh.position.z = position[2];	
						mesh.rotation.x = rotation[0];
						mesh.rotation.y = rotation[1];
						mesh.rotation.z = rotation[2];
						scene.position.z = -10;
						//scene.add(mesh);

						switch(path){
							case 'json/cat.json':
								cat = mesh;
							break;
							case 'json/rat.js':
								rat = mesh;
							break;
							case 'json/knife.js':
								knife = mesh;
							break;
							case 'json/cheese.js':
								cheese = mesh;
							break;
						}
					}
				}

				setTimeout(function () {
					scene.add(cat);
					scene.add(rat);
					scene.add(knife);
					scene.add(cheese);
					animate();
				}, 500); // tempo necessário para o objeto ser carregado
			}
			
			var startTime = Date.now();
			var timeDelta = 0;
			
			function animate() {
				timeDelta = Date.now() - startTime;
				requestAnimationFrame(animate);
				// catMesh.material.uniforms.timeDelta.value = timeDelta;

				if (keyboard.pressed("1"))
					sideCameraEnabled = true;
				if (keyboard.pressed("2"))
					sideCameraEnabled = false;

				render();	
			}

			function render() {
				renderer.clear();

				if (sideCameraEnabled)
					renderer.render(scene, sideCamera);
				else
		  			renderer.render(scene, upCamera); 

			}
		</script>
	</body>
</html>
